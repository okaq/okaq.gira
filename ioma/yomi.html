<!DOCTYPE html>
<html lang="en">
    <head id="zeta">
        <title>okaq</title>
        <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
        <meta name="viewport" content="width=1920,height=1080,initial-scale=1" />
        <meta name="source" content="https://github.com/okaq/okaq.gira" />
        <meta name="creator" content="AQ<aq@okaq.com>" />
        <meta name="date" content="2015-02-06" />
        <link rel="shortcut icon" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAIAAAD8GO2jAAAAMklEQVR4nGJ51vKfgZaAiaamj1owasGoBaMWjFowasGoBaMWjFowasGoBVQEgAAAAP//6ncCrDkNKVcAAAAASUVORK5CYII=" />
        <style type="text/css">
            html,body{width:1920px;height:1080px;margin:0px;border:0px;padding:0px;background-color:rgba(255,255,255,1.0);}
        </style>
        <script src="http://cdn.peerjs.com/0.3/peer.js"></script>
        <script type="text/javascript">
            // ok
        console.log("okaq gira ioma peering!");
        // async
        (function() {
         window.addEventListener("load",function(e){g.init(e);},false);
         })();
// game
var g = {
    "init": function(e) {
        console.log(e);
        var now = window.performance.now();

        // subsystems
        g.subs = [stats,net];
        g.subs.forEach(function(el){el.init();});

        // stats
        var done = window.performance.now();
        console.log("total run time: " + (done - now) + "ms.");
    }
}
// stats
var stats = {
    "init": function() {
        stats.perf = {};
    },
    "set": function(k0) {
        stats.perf[k0] = [];
    },
    "start": function(k0) {
        stats.perf[k0][0] = window.performance.now();
    },
    "split": function(k0) {
        stats.perf[k0].push(window.performance.now());
        var d0 = stats.perf[k0].length;
        var d1 = stats.perf[k0][d0-1] - stats.perf[k0][d0-2];
        return d1;
    },
    "end": function(k0) {
        var d0 = stats.split(k0);
        var d1 = stats.perf[k0].length-1;
        var d2 = stats.perf[k0][d1] - stats.perf[k0][0];
        return [d0, d2];
    }
}
// peerjs
var net = {
    "init": function() {
        net.xhrInit();
        // net.peerInit();
    },
    "peerInit": function() {
        stats.set("peer");
        stats.start("peer");
        // peerjs
        // id is assigned at creation
        // get id from server first, then connect peers
        // use net.pid as id, net.pkey as key
        // net.peer = new Peer(net.id, {key:net.id.Key,debug:3});
        // net.peer = new Peer({key: 'wrcrx9bkcwlpiudi'});
        net.peer = new Peer({key:net.id.Key,debug:3});
        net.peer.on("error", net.error);
        net.peer.on("open", function(id){
                console.log(id);
                net.id = id;
            });
        console.log(net.peer);
        net.route();
        // var t0 = stats.end("peer");
        // console.log("Peer init time: " + t0[1]);
    },
    "xhrInit": function() {
        // xhr
        stats.set("xhr");
        stats.start("xhr");
        net.xhr = new XMLHttpRequest();
        console.log(net.xhr);
        // get id, key from server json call
        net.xhr.addEventListener("load", net.load, false);
        net.urls = [
            "http://localhost:8080/key",
            "http://localhost:8080/peer"
            ];
        net.open();
        t0 = stats.end("xhr");
        console.log("Xhr init time: " + t0[1]);
    },
    "load": function(e) {
        console.log(e);
        // console.log(net.xhr.response);
        net.id = JSON.parse(net.xhr.response);
        console.log(net.id.Id,net.id.Key,net.id.Conn);
        // net.pid = net.id.Id; // peer id
        // net.route();
        net.peerInit();
    },
    "route": function() {
        /*
        if (net.id.Conn) {
            net.pid = net.pid - 1;
            net.connect();
        } else {
            net.pid = net.pid + 1;
            net.wait();
            }
        */
        // get peer ids list from server

    },
    "open": function() {
        net.xhr.open("GET", net.urls[0], true);
        net.xhr.requestType = "json";
        net.xhr.send();
    },
    "wait": function() {
        console.log("Waiting for peer to initiate connection");
    },
    "connect": function() {
        console.log("Initiating connection");
        // time, stats for all conn events
        // performance map, splits, perf["conn_0"] = [now(),...]
        net.pc = net.peer.connect(net.pid);
        console.log(net.pc);
    },
    "error": function(err) {
        console.log(err);
    }
}
</script>
</head>
<body id="alpha">
</body>
</html>


